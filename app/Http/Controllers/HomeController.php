<?php

namespace App\Http\Controllers;

use App\Models\Job;
use App\Models\User;
use App\Models\Person;
use App\Services\PersonJobService;
use App\Services\PersonService;
use App\Services\RateService;
use Illuminate\Http\Request;

class HomeController extends Controller
{
    public $userId;

    /**
     * Display a listing of the resource.
     *
     * @return \Illuminate\Http\Response
     * 
     */
    public function index(Request $request)
    {
        $data = [
            'title' => 'Home'
        ];
        //userid is in the user localstorage
        // $userId = 5;
        $userId = $request->input('userId');

        if ($userId) {

            $person = Person::getPersonByUserId($userId);
            //add person details
            $data['person'] = $person;
            // add job match rates 
            $personJobService = new PersonJobService($person);
            $data['all_job_match_rates'] = $personJobService->getAllJobMatchRates();
            $data['job_match_rates'] = array_slice($personJobService->getAllJobMatchRates(), 0, 10);
            return ($data);
        } else {
            return ('userId is missing.');
        }
    }

    public function demo()
    {
        $data = [
            'title' => 'Demo'
        ];
        return view('demo',  $data);
    }


    /**
     * show data for selected job
     *
     * @param [int] $id
     * @return void
     */
    public function job_insight($id = null)
    {

        $person = Person::getPersonById($this->personId);
        $jobId = $id;
        //get job name
        $job = Job::getJobById($jobId);
        $jobName = $job['job_name'];

        $personService = new PersonService($person);
        $workprefsArray = $personService->getWorkprefsById($this->personId);

        $rateService = new RateService($person, $job);
        $driversLicenseRate = $rateService->getDriversLicenseRate($this->personId, $jobId);
        $workprefsRate = $rateService->getWorkPrefRate($this->personId, $jobId);
        $skillsRate = $rateService->getSkillsRate($this->personId, $jobId);

        $averageRate = $rateService->getAverageRate();

        $data = [
            'title' => 'Job Insight',
            'average_rate' => $averageRate,
            'job_name' => $jobName,
            'skills_rate' => $skillsRate,
            'drivers_license_rate' => $driversLicenseRate,
            'workprefs_rate' => $workprefsRate,
            'modaltitle' => 'edit work day, time and location preferences',
            'modaltext' => 'select or deselect preferred options.',
            'workprefs_array' => $workprefsArray,
        ];

        return view('job_insight', $data);
    }
    public function about()
    {
        $data = [
            'title' => 'About',
        ];
        return view('about', $data);
    }
}

<?php

namespace App\Services;

use App\Models\Job;
use Exception;

class JobService
{
    protected $job;

    public function __construct(Job $job)
    {
        $this->job = $job;
        $this->dayCases =  [
            'sd1' =>    '00001',
            'sd2' =>    '00010',
            'sd3' =>    '00100',
            'sd4' =>    '00110',
            'sd5' =>    '01000',
            'sd6' =>    '01010',
            'sd7' =>    '10000',
            'sd8' =>    '10010',
            'sd9' =>    '10100',
            'sd10' =>   '11000',
            'sd11' =>   '11010',
            'sd12' =>   '10110',
            'sd13' =>   '11100',
            'sd14' =>   '11110',
            'sd15' =>   '01100'
        ];
        $this->hourCases = [
            // normal_hours
            'sh1' => '10000',
            // normal + nightshift
            'sh2' => '11000',
            // normal + other_shift
            'sh3' => '10010',
            // normal + ns + os
            'sh4' => '11010',
            // nightshift_only
            'sh5' => '01100',
            // other_shift_only
            'sh6' => '00011',
            // nightshift + other_shift
            'sh7' => '01010',
        ];
    }

    public  function storeJobWorkPrefChanges($request)
    {
        $error = "";
        
        // eliminate requests that don't make sense
        // workplace settings
        $dpw = $request['workplace'];
        $dpr = $request['remote'];
        $code1 = $dpw . $dpr;
        if ($code1 == "11" || $code1 == "00") {
            $error = 'this setup is not permitted';
        }

        // workday settings
        $du1 = $request['workdays'] ? 1 : 0;
        $du2 = $request['saturday'] ? 1 : 0;
        $du3 = $request['sunday'] ? 1 : 0;
        $du4 = $request['bank_holidays'] ? 1 : 0;
        $du5 = $request['sat_sun_bh_only'] ? 1 : 0;
        
        $code2 = $du1 . $du2 . $du3 . $du4 . $du5;
        
        if (!in_array($code2, $this->dayCases)) {
            $error = 'this setup is not permitted';
        }
        
        // workhour settings
        // build above setup from current database values
        $hu1 = $request['normal_hours'] ? 1 : 0;
        $hu2 = $request['nightshift'] ? 1 : 0;
        $hu3 = $request['nightshift_only'] ? 1 : 0;
        $hu4 = $request['other_shift'] ? 1 : 0;
        $hu5 = $request['other_shift_only'] ? 1 : 0;

        $code3 = $hu1 . $hu2 . $hu3 . $hu4 . $hu5;

        if (!in_array($code3, $this->hourCases)) {
            return 'this setup is not permitted';
        }

        $this->job->workplace = $request['workplace'];
        $this->job->remote = $request['remote'];
        $this->job->workdays = $request['workdays'];
        $this->job->saturday = $request['saturday'];
        $this->job->sunday = $request['sunday'];
        $this->job->bank_holidays = $request['bank_holidays'];
        $this->job->sat_sun_bh_only = $request['sat_sun_bh_only'];
        $this->job->normal_hours = $request['normal_hours'];
        $this->job->nightshift = ($request['nightshift_only'] == 1) ? 1 : $request['nightshift'];
        $this->job->nightshift_only = $request['nightshift_only'];
        $this->job->other_shift = ($request['other_shift_only'] == 1) ? 1 : $request['other_shift'];
        $this->job->other_shift_only = $request['other_shift_only'];
        $this->job->overtime = $request['overtime'];

        try {
            $this->job->save();
        } catch (Exception $e) {
            return $e;
        }
        if ($error) {
            return $error;
        }
    }
}
